# Metrist Datasource for Grafana

## Getting started

Add the golang and mage plugin through asdf and install the required versions stated in `.tool-versions`

```bash
 asdf plugin-add golang
 asdf plugin-add mage
 asdf plugin-add nodejs
 asdf install
```

Quickest way to get started is to run

```bash
# NPM
npm ci

# Go
go get
go install github.com/deepmap/oapi-codegen/cmd/oapi-codegen@latest # Required for openapi codegen
asdf reshim

mage -v                     # Build the backend
npm run dev                 # Build the frontend
npm run server              # Run grafana server
npm run server:with-plugin  # Run grafana server with the datasource plugin ready to be installed
```


#### Running the Frontend, Backend and Installing the plugin

1. Run `npm run server:with-plugin`
2. In a separate terminal run the frontend `npm run dev`
3. Head over to `http://localhost:3000/datasources` -> `Add data source` -> Search for `Metrist`
4. Click on the `Metrist` plugin. This will install the plugin
5. Configure the `API Key` and click `Save and test`

### Frontend

1. Install dependencies

   ```bash
   npm install
   ```

2. Build plugin in development mode or run in watch mode

   ```bash
   npm run dev

   # or

   npm run watch
   ```

3. Build plugin in production mode

   ```bash
   npm run build
   ```

4. Run the tests (using Jest)

   ```bash
   # Runs the tests and watches for changes
   npm run test

   # Exists after running all the tests
   npm run lint:ci
   ```

5. Spin up a Grafana instance and run the plugin inside it (using Docker)

   ```bash
   npm run server
   ```

6. Run the E2E tests (using Cypress)

   ```bash
   # Spin up a Grafana instance first that we tests against
   npm run server

   # Start the tests
   npm run e2e
   ```

7. Run the linter

   ```bash
   npm run lint

   # or

   npm run lint:fix
   ```

### Backend

1. Update [Grafana plugin SDK for Go](https://grafana.com/docs/grafana/latest/developers/plugins/backend/grafana-plugin-sdk-for-go/) dependency to the latest minor version:

   ```bash
   go get
   ```

2. Build backend plugin binaries for Linux, Windows and Darwin:

   ```bash
   mage -v
   ```

3. List all available Mage targets for additional commands:

   ```bash
   mage -l
   ```

#### OpenAPI Generated Code

The code in `pkg/internal/openapi.go` is generated by [oapi-codegen](https://github.com/deepmap/oapi-codegen). Our backend exposes an openapi v3 spec at /api/openapi which codegen can use
1. install oapi codegen
`go install github.com/deepmap/oapi-codegen/cmd/oapi-codegen@latest` then `asdf reshim` if using asdf
2. Run the following to generate the go file

   ```bash
   oapi-codegen -package internal -generate types,client <url to /api/openapi for backend>.yaml >  pkg/internal/openapi.go
   ```

## Learn more

Below you can find source code for existing app plugins and other related documentation.

- [Basic data source plugin example](https://github.com/grafana/grafana-plugin-examples/tree/master/examples/datasource-basic#readme)
- [Plugin.json documentation](https://grafana.com/docs/grafana/latest/developers/plugins/metadata/)
- [How to sign a plugin?](https://grafana.com/docs/grafana/latest/developers/plugins/sign-a-plugin/)
